#!/bin/bash

set -o errexit
set -o nounset

help="Usage: $(basename "$0") [-d|--destination <dir>] [-q|--quality <quality>] [-a|--album] [-r|--remove] <file1> {<fileN>, ...}

Encodes to m4a and applies gain.

\`--album\` applies album gain (otherwise, track gain is applied).

The codec used is libfdk_aac, in VBR, with a default quality of 3 (~110 kbps).

Requires aacgain and a recompiled FFmpeg.

Please note that not all the input/quality combinations work (see https://hydrogenaud.io/index.php/topic,95989.msg817833.html#msg817833).
"

eval set -- "$(getopt --options hd:q:ar --long help,destination:,quality:,album,remove -- "$@")"

destination="."
quality="3"
gain_option="-r"
remove_file=

while true ; do
  case "$1" in
    -h|--help)
      echo "$help"
      exit 0 ;;
    -d|--destination)
      destination="$2"
      shift 2 ;;
    -q|--quality)
      quality="$2"
      shift 2 ;;
    -a|--album)
      gain_option="-a"
      shift ;;
    -r|--remove)
      remove_file=1
      shift ;;
    --)
      shift
      break ;;
  esac
done

if [[ $# -eq 0 ]]; then
  echo "$help"
  exit 1
fi

destination_filenames=()

for source_filename in "$@"; do
  destination_filename="$destination/${source_filename%.*}.m4a"

  ffmpeg -y -i "$source_filename" -vn -c:a libfdk_aac -vbr "$quality" "$destination_filename"

  destination_filenames+=("$destination_filename")

  [[ $remove_file == 1 ]] && rm "$source_filename" || true
done

# `-s -r`: ignore ffmpeg written tags, which set the album gain for each track separately.
#
aacgain -k "$gain_option" -s r "${destination_filenames[@]}"
