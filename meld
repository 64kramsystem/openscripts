#!/usr/bin/env bash

set -o pipefail
set -o errexit
set -o nounset
set -o errtrace
shopt -s inherit_errexit

c_meld_path_win="/mnt/c/Program Files/Meld//Meld.exe"
c_meld_path_linux=${MELD_PATH:-/usr/bin/meld}
c_meld_path_mac=${MELD_PATH:-/opt/homebrew/bin/meld}

# Necessary when running the binary from the source repository.
function remove_active_venv {
  PATH=${PATH//$VIRTUAL_ENV\/bin:/}
  unset VIRTUAL_ENV
  unset PYTHONHOME
}

# shellcheck disable=2034
function set_meld_path {
  local -n meld_path_out=$1

  if [[ ${WSL_DISTRO_NAME:-} != "" ]]; then
    meld_path_out=$c_meld_path_win
  elif [[ $(uname) == "Darwin" ]]; then
    meld_path_out=$c_meld_path_mac
  else
    meld_path_out=$c_meld_path_linux
  fi
}

function run_meld {
  if [[ $# -eq 0 ]]; then
    "$meld_path" /dev/null /dev/null
  else
    "$meld_path" "$@"
  fi
}

function main {
  if [[ -n ${VIRTUAL_ENV:-} ]]; then
    remove_active_venv
  fi
  local meld_path
  set_meld_path meld_path
  run_meld "$@"
}

# If meld is opened without params, it opens with the user dialog; since opening two blank panels is
# a common use case, this wrapper starts this way by default.
main "$@"
